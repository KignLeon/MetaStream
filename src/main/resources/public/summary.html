<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MetaStream Live | Summary</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>

<body class="bg-gradient-to-b from-white to-gray-50 flex items-center justify-center min-h-screen">
    <div class="bg-white rounded-2xl shadow-lg max-w-lg w-full p-10 text-center">

        <!-- Success Icon -->
        <svg class="w-16 h-16 text-green-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none"
            viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round"
                d="M9 12.75l2.25 2.25L15 9.75M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z" />
        </svg>

        <h1 class="text-3xl font-bold mb-2">Stream Ended</h1>
        <p class="text-gray-600 mb-8">Here's your session summary:</p>

        <!-- Stats Grid -->
        <div class="grid grid-cols-2 gap-4 mb-8">
            <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-5 text-left">
                <p class="text-sm text-blue-600 font-semibold mb-1">Duration</p>
                <p class="text-2xl font-bold text-blue-900" id="duration">--:--:--</p>
            </div>

            <div class="bg-gradient-to-br from-purple-50 to-purple-100 rounded-xl p-5 text-left">
                <p class="text-sm text-purple-600 font-semibold mb-1">Peak Viewers</p>
                <p class="text-2xl font-bold text-purple-900" id="peakViewers">0</p>
            </div>

            <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-5 text-left">
                <p class="text-sm text-green-600 font-semibold mb-1">Messages</p>
                <p class="text-2xl font-bold text-green-900" id="totalMessages">0</p>
            </div>

            <div class="bg-gradient-to-br from-orange-50 to-orange-100 rounded-xl p-5 text-left">
                <p class="text-sm text-orange-600 font-semibold mb-1">Notifications</p>
                <p class="text-2xl font-bold text-orange-900" id="notifications">0</p>
            </div>
        </div>

        <!-- Actions -->
        <div class="flex flex-col sm:flex-row gap-3">
            <a href="index.html"
                class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-3 rounded-lg transition-all text-center">
                New Stream
            </a>
            <button id="downloadBtn"
                class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg transition-all">
                Download Log
            </button>
        </div>

        <p class="text-xs text-gray-400 mt-6">
            Session ID: <span id="sessionId" class="font-mono">--</span>
        </p>
    </div>

    <script>
        const API_BASE = 'http://localhost:8080/api';

        // Load summary from last session
        async function loadSummary() {
            try {
                // Try to get active session info (might still be available)
                const res = await fetch(`${API_BASE}/stream/active`);

                if (res.ok) {
                    const data = await res.json();
                    displaySummary(data);
                } else {
                    // If no active session, show placeholder
                    document.getElementById('duration').textContent = 'N/A';
                    document.getElementById('peakViewers').textContent = 'N/A';
                    document.getElementById('totalMessages').textContent = 'N/A';
                    document.getElementById('notifications').textContent = 'N/A';
                }
            } catch (err) {
                console.error('Failed to load summary:', err);
            }
        }

        function displaySummary(data) {
            document.getElementById('duration').textContent = data.duration || '--:--:--';
            document.getElementById('peakViewers').textContent = data.peakViewers || 0;
            document.getElementById('totalMessages').textContent = data.messages || 0;
            document.getElementById('notifications').textContent = data.notificationsSent || 0;
            document.getElementById('sessionId').textContent = data.sessionId || 'N/A';
        }

        // Download chat log
        document.getElementById('downloadBtn').addEventListener('click', async () => {
            try {
                const res = await fetch(`${API_BASE}/chat/messages`);
                const messages = await res.json();

                // Create downloadable text file
                let logContent = 'MetaStream Live - Chat Log\n';
                logContent += '='.repeat(50) + '\n\n';

                messages.forEach(msg => {
                    logContent += `[${msg.timestamp}] ${msg.author}: ${msg.text}\n`;
                });

                const blob = new Blob([logContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `metastream-log-${Date.now()}.txt`;
                a.click();
                URL.revokeObjectURL(url);

            } catch (err) {
                console.error('Download failed:', err);
                alert('‚ùå Failed to download log');
            }
        });

        loadSummary();
    </script>
</body>

</html>