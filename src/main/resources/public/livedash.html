<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MetaStream Live | Dashboard</title>

    <!-- Tailwind & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="css/style.css" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <link rel="icon" href="/assets/favicon.ico" type="image/x-icon" />
</head>

<body class="text-gray-900 antialiased bg-gradient-to-b from-white to-[#f0f2f9] font-sans">
    <!-- Header -->
    <header class="main-header border-b border-gray-100 pb-4 mb-6">
        <div class="logo">
            <i class="fa-solid fa-infinity logo-icon"></i>
            <span id="usernameDisplay">MetaStream Live</span>
            <span class="live-indicator">LIVE</span>
        </div>

        <div class="user-nav">
            <div class="nav-icon flex items-center justify-center">
                <i class="fa-regular fa-bell text-gray-500"></i>
            </div>
            <div class="nav-icon profile flex items-center justify-center">
                <i class="fa-solid fa-user text-gray-600"></i>
            </div>
        </div>
    </header>

    <!-- Main Dashboard -->
    <main class="dashboard-container">
        <!-- Stream Panel -->
        <section class="stream-panel">
            <div class="video-player flex items-center justify-center text-gray-400 text-lg relative">
                <p id="streamInfo" class="text-center">
                    Fetching stream data...
                </p>
            </div>

            <div class="stream-stats">
                <div class="stat-item">
                    <i class="fa-solid fa-eye stat-icon"></i>
                    <strong id="viewerCount">0</strong>
                    <span>Viewers</span>
                </div>
                <div class="stat-item">
                    <i class="fa-regular fa-clock stat-icon"></i>
                    <strong id="duration">--:--:--</strong>
                    <span>Duration</span>
                </div>
                <div id="stopStreamTrigger" class="stat-item cursor-pointer hover:text-gray-800">
                    <i class="fa-solid fa-square stat-icon text-red-500"></i>
                    <span>Stop Stream</span>
                </div>
            </div>

            <div class="stream-actions">
                <button id="stopStreamBtn" class="btn btn-stop">Stop Stream</button>
                <button class="btn btn-logs">View Logs</button>
            </div>
        </section>

        <!-- Chat Panel -->
        <aside class="chat-panel">
            <h2>Live Chat</h2>

            <!-- Chat Messages -->
            <div id="chatMessages" class="chat-messages">
                <p class="text-gray-400 text-sm text-center mt-4">
                    No messages yet...
                </p>
            </div>

            <!-- Chat Input -->
            <div class="chat-input-area">
                <input id="chatInput" type="text" placeholder="Send a message..." class="focus:outline-none" />
            </div>

            <!-- Chat Toggles -->
            <div class="chat-toggles">
                <div class="toggle-row">
                    <div class="toggle-label">
                        <div class="toggle-icon flex items-center justify-center">
                            <i class="fa-solid fa-sms text-blue-600"></i>
                        </div>
                        Enable SMS Alerts
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" checked />
                        <span class="slider"></span>
                    </label>
                </div>

                <div class="toggle-row">
                    <div class="toggle-label">
                        <div class="toggle-icon tts flex items-center justify-center">
                            <i class="fa-solid fa-volume-high text-green-600"></i>
                        </div>
                        Enable TTS Audio
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" />
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </aside>
    </main>

    <footer class="text-center text-sm text-gray-500 mt-6">
        Â© 2025 MetaStream Live. Powered by Meta-inspired design.
    </footer>

    <script>
        const streamInfo = document.getElementById("streamInfo");
        const usernameDisplay = document.getElementById("usernameDisplay");
        const viewerCount = document.getElementById("viewerCount");
        const durationEl = document.getElementById("duration");
        const chatInput = document.getElementById("chatInput");
        const chatMessages = document.getElementById("chatMessages");

        // Fetch session details
        async function loadStreamInfo() {
            try {
                const res = await fetch("/activeStream");
                if (!res.ok) throw new Error("No active stream.");
                const data = await res.json();

                usernameDisplay.textContent = data.username + " â€” Dashboard";
                streamInfo.innerHTML = `
          <div class="text-gray-600 text-sm">
            <p><strong>RTMP URL:</strong> ${data.rtmpUrl}</p>
            <p><strong>Started:</strong> ${data.startedAt}</p>
            <p><strong>Messages:</strong> ${data.messages}</p>
          </div>
        `;
                viewerCount.textContent = Math.floor(Math.random() * 500) + 50; // Mock viewer count
                startTimer(data.startedAt);
            } catch (err) {
                streamInfo.innerHTML =
                    "<p class='text-red-500'>No active stream session found.</p>";
            }
        }

        // Simple duration counter
        function startTimer(startTime) {
            const start = new Date(startTime);
            setInterval(() => {
                const diff = new Date() - start;
                const hrs = Math.floor(diff / 3600000);
                const mins = Math.floor((diff % 3600000) / 60000);
                const secs = Math.floor((diff % 60000) / 1000);
                durationEl.textContent = `${hrs.toString().padStart(2, "0")}:${mins
                    .toString()
                    .padStart(2, "0")}:${secs.toString().padStart(2, "0")}`;
            }, 1000);
        }

        // Stop stream
        async function stopStream() {
            if (!confirm("Are you sure you want to stop the stream?")) return;
            const res = await fetch("/stopStream", { method: "POST" });
            if (res.ok) {
                alert("ðŸ›‘ Stream stopped successfully.");
                window.location.href = "summary.html";
            } else {
                alert("Error stopping stream.");
            }
        }

        document
            .getElementById("stopStreamBtn")
            .addEventListener("click", stopStream);
        document
            .getElementById("stopStreamTrigger")
            .addEventListener("click", stopStream);

        // Mock chat send (to backend later)
        chatInput.addEventListener("keydown", async (e) => {
            if (e.key === "Enter" && chatInput.value.trim() !== "") {
                const msg = chatInput.value.trim();
                chatMessages.innerHTML += `
          <div class="message outgoing">
            <div class="message-content">
              <strong>You</strong>
              <p>${msg}</p>
            </div>
            <span class="message-timestamp">${new Date().toLocaleTimeString()}</span>
          </div>`;
                chatInput.value = "";
                chatMessages.scrollTop = chatMessages.scrollHeight;

                await fetch("/sendMessage", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ author: "You", text: msg }),
                });
            }
        });

        // Load stream info on page load
        loadStreamInfo();
    </script>
</body>

</html>