<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MetaStream Live - Broadcasting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
        }
        
        body {
            background: #0a0a0a;
            overflow-x: hidden;
        }
        
        .glow-card {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .live-badge {
            animation: livePulse 2s ease-in-out infinite;
        }
        
        @keyframes livePulse {
            0%, 100% {
                box-shadow: 0 0 20px rgba(239, 68, 68, 0.5);
            }
            50% {
                box-shadow: 0 0 30px rgba(239, 68, 68, 0.8);
            }
        }
        
        #videoPlayer {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #000;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-connected {
            background: #10b981;
            box-shadow: 0 0 10px #10b981;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        .status-disconnected {
            background: #ef4444;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .chat-bubble {
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="text-white">
    
    <!-- Top Bar -->
    <nav class="bg-black/50 backdrop-blur-xl border-b border-white/10 sticky top-0 z-50">
        <div class="max-w-[1800px] mx-auto px-6 py-4">
            <div class="flex justify-between items-center">
                <!-- Logo & Status -->
                <div class="flex items-center gap-6">
                    <div class="flex items-center gap-3">
                        <svg class="w-8 h-8 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="m15.75 10.5 4.72-4.72a.75.75 0 0 1 1.28.53v11.38a.75.75 0 0 1-1.28.53l-4.72-4.72M4.5 18.75h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25h-9A2.25 2.25 0 0 0 2.25 7.5v9a2.25 2.25 0 0 0 2.25 2.25Z" />
                        </svg>
                        <div>
                            <h1 class="text-lg font-bold">MetaStream</h1>
                            <p id="streamerName" class="text-xs text-gray-400"></p>
                        </div>
                    </div>
                    
                    <div class="live-badge bg-red-500 px-4 py-1.5 rounded-full flex items-center gap-2">
                        <span class="w-2 h-2 bg-white rounded-full"></span>
                        <span class="text-xs font-bold uppercase">Live</span>
                    </div>
                </div>
                
                <!-- WebSocket Status & Stop Button -->
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 text-sm">
                        <span id="wsStatus" class="status-dot status-disconnected"></span>
                        <span id="wsStatusText" class="text-gray-400">Connecting...</span>
                    </div>
                    
                    <button onclick="stopStream()" class="bg-red-500 hover:bg-red-600 text-white font-semibold px-6 py-2.5 rounded-lg transition-all flex items-center gap-2">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5.25 7.5A2.25 2.25 0 017.5 5.25h9a2.25 2.25 0 012.25 2.25v9a2.25 2.25 0 01-2.25 2.25h-9a2.25 2.25 0 01-2.25-2.25v-9z" />
                        </svg>
                        End Stream
                    </button>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <div class="max-w-[1800px] mx-auto px-6 py-8">
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
            
            <!-- Left: Video & Stats (2/3) -->
            <div class="xl:col-span-2 space-y-6">
                
                <!-- Video Player -->
                <div class="glow-card rounded-2xl overflow-hidden">
                    <div class="relative aspect-video bg-black">
                        <video id="videoPlayer" controls autoplay muted></video>
                        
                        <!-- Loading -->
                        <div id="videoLoading" class="absolute inset-0 bg-black/90 flex items-center justify-center">
                            <div class="text-center">
                                <svg class="animate-spin h-16 w-16 text-purple-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                <p class="text-white text-sm">Loading stream...</p>
                                <p class="text-gray-500 text-xs mt-2">Waiting for OBS connection...</p>
                            </div>
                        </div>
                        
                        <!-- Error -->
                        <div id="videoError" class="hidden absolute inset-0 bg-black/95 flex items-center justify-center">
                            <div class="text-center px-4">
                                <svg class="h-20 w-20 text-red-500 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
                                </svg>
                                <p class="text-white font-semibold text-lg mb-2">Stream Unavailable</p>
                                <p class="text-gray-400 text-sm" id="videoErrorMessage">Start streaming from OBS...</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Stats Grid -->
                <div class="grid grid-cols-3 gap-4">
                    <!-- Duration -->
                    <div class="glow-card rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-blue-500/20 to-purple-500/20 rounded-xl flex items-center justify-center">
                                <svg class="w-7 h-7 text-blue-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 font-semibold uppercase tracking-wider">Duration</p>
                                <p id="duration" class="text-2xl font-bold text-white font-mono mt-1">00:00:00</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Viewers -->
                    <div class="glow-card rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-purple-500/20 to-pink-500/20 rounded-xl flex items-center justify-center">
                                <svg class="w-7 h-7 text-purple-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 010-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178z" />
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 font-semibold uppercase tracking-wider">Viewers</p>
                                <p id="viewerCount" class="text-2xl font-bold text-white mt-1">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Messages -->
                    <div class="glow-card rounded-xl p-6">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-green-500/20 to-teal-500/20 rounded-xl flex items-center justify-center">
                                <svg class="w-7 h-7 text-green-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
                                </svg>
                            </div>
                            <div>
                                <p class="text-xs text-gray-400 font-semibold uppercase tracking-wider">Messages</p>
                                <p id="messageCount" class="text-2xl font-bold text-white mt-1">0</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Stream Info -->
                <div class="glow-card rounded-xl p-6">
                    <h3 class="text-sm font-bold text-gray-300 mb-4 uppercase tracking-wider">Stream Configuration</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center py-3 border-b border-white/5">
                            <span class="text-sm text-gray-400">RTMP Ingest</span>
                            <code class="bg-white/5 px-3 py-1.5 rounded text-xs text-gray-300 font-mono">rtmp://localhost/live/stream</code>
                        </div>
                        <div class="flex justify-between items-center py-3 border-b border-white/5">
                            <span class="text-sm text-gray-400">HLS Playback</span>
                            <code class="bg-white/5 px-3 py-1.5 rounded text-xs text-gray-300 font-mono">http://localhost:8000/live/stream/index.m3u8</code>
                        </div>
                        <div class="flex justify-between items-center py-3">
                            <span class="text-sm text-gray-400">Session ID</span>
                            <code id="sessionId" class="bg-white/5 px-3 py-1.5 rounded text-xs text-gray-300 font-mono">---</code>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Right: Live Chat (1/3) -->
            <div class="xl:col-span-1">
                <div class="glow-card rounded-2xl flex flex-col" style="height: calc(100vh - 180px);">
                    <!-- Chat Header -->
                    <div class="p-6 border-b border-white/10">
                        <h2 class="text-lg font-bold text-white">Live Chat</h2>
                        <p class="text-xs text-gray-400 mt-1">Send messages in real-time</p>
                    </div>
                    
                    <!-- Chat Messages -->
                    <div id="chatMessages" class="flex-1 overflow-y-auto p-6 space-y-4">
                        <div class="text-center py-12">
                            <svg class="w-16 h-16 text-gray-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 01-.825-.242m9.345-8.334a2.126 2.126 0 00-.476-.095 48.64 48.64 0 00-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0011.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.76 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155" />
                            </svg>
                            <p class="text-sm text-gray-400">No messages yet</p>
                            <p class="text-xs text-gray-500 mt-1">Be the first to chat!</p>
                        </div>
                    </div>
                    
                    <!-- Chat Input -->
                    <form id="chatForm" class="p-4 border-t border-white/10">
                        <div class="flex gap-2">
                            <input 
                                type="text" 
                                id="chatInput" 
                                placeholder="Type a message..." 
                                maxlength="500"
                                class="flex-1 px-4 py-3 bg-white/5 border border-white/10 rounded-lg focus:outline-none focus:border-purple-500 focus:ring-2 focus:ring-purple-500/20 text-white placeholder-gray-500 text-sm"
                            />
                            <button 
                                type="submit" 
                                class="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white px-6 py-3 rounded-lg font-semibold transition-all flex items-center gap-2"
                            >
                                <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" />
                                </svg>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        const API_BASE = 'http://localhost:8080/api';
        const WS_URL = 'ws://localhost:8080/ws';
        
        let ws = null;
        let username = 'Streamer';
        let sessionId = null;
        let messageCount = 0;
        let startTime = Date.now();
        let durationInterval = null;
        let hlsPlayer = null;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 5;
        
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch(`${API_BASE}/stream/session`);
                
                if (!response.ok) {
                    alert('No active session. Redirecting...');
                    window.location.href = '/index.html';
                    return;
                }
                
                const sessionData = await response.json();
                sessionId = sessionData.sessionId;
                username = sessionData.user.username;
                
                document.getElementById('streamerName').textContent = `Streaming as ${username}`;
                document.getElementById('sessionId').textContent = sessionId;
                
                initializeVideo();
                initializeWebSocket();
                startDurationTimer();
                
            } catch (error) {
                alert('Failed to load session. Please try again.');
                window.location.href = '/index.html';
            }
        });
        
        function initializeVideo() {
            const video = document.getElementById('videoPlayer');
            const hlsUrl = 'http://localhost:8000/live/stream/index.m3u8';
            
            if (Hls.isSupported()) {
                hlsPlayer = new Hls({ enableWorker: true, lowLatencyMode: true });
                hlsPlayer.loadSource(hlsUrl);
                hlsPlayer.attachMedia(video);
                
                hlsPlayer.on(Hls.Events.MANIFEST_PARSED, () => {
                    document.getElementById('videoLoading').classList.add('hidden');
                    video.play().catch(e => console.warn('Autoplay prevented'));
                });
                
                hlsPlayer.on(Hls.Events.ERROR, (event, data) => {
                    if (data.fatal) {
                        document.getElementById('videoError').classList.remove('hidden');
                        setTimeout(() => hlsPlayer.loadSource(hlsUrl), 3000);
                    }
                });
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                video.src = hlsUrl;
                video.addEventListener('loadedmetadata', () => {
                    document.getElementById('videoLoading').classList.add('hidden');
                    video.play();
                });
            }
        }
        
        function initializeWebSocket() {
            ws = new WebSocket(WS_URL);
            
            ws.onopen = () => {
                reconnectAttempts = 0;
                updateWebSocketStatus('connected');
                ws.send(JSON.stringify({ type: 'identify', username }));
            };
            
            ws.onmessage = (event) => {
                try {
                    const message = JSON.parse(event.data);
                    if (message.type === 'chat') {
                        addChatMessage(message.author, message.text, message.timestamp);
                    }
                } catch (error) {
                    console.error('Error parsing message:', error);
                }
            };
            
            ws.onerror = () => updateWebSocketStatus('disconnected');
            
            ws.onclose = () => {
                updateWebSocketStatus('disconnected');
                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    reconnectAttempts++;
                    setTimeout(initializeWebSocket, 2000);
                }
            };
        }
        
        function updateWebSocketStatus(status) {
            const indicator = document.getElementById('wsStatus');
            const text = document.getElementById('wsStatusText');
            
            if (status === 'connected') {
                indicator.className = 'status-dot status-connected';
                text.textContent = 'Connected';
                text.classList.add('text-green-400');
                text.classList.remove('text-red-400', 'text-yellow-400');
            } else {
                indicator.className = 'status-dot status-disconnected';
                text.textContent = 'Disconnected';
                text.classList.add('text-red-400');
                text.classList.remove('text-green-400', 'text-yellow-400');
            }
        }
        
        function addChatMessage(author, text, timestamp) {
            const container = document.getElementById('chatMessages');
            
            if (container.querySelector('svg')) {
                container.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'chat-bubble flex items-start gap-3';
            
            const time = new Date(timestamp).toLocaleTimeString('en-US', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            messageDiv.innerHTML = `
                <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-blue-600 rounded-full flex items-center justify-center text-white font-bold text-sm flex-shrink-0">
                    ${author[0].toUpperCase()}
                </div>
                <div class="flex-1">
                    <div class="flex items-baseline gap-2 mb-1">
                        <span class="font-semibold text-sm text-white">${escapeHtml(author)}</span>
                        <span class="text-xs text-gray-500">${time}</span>
                    </div>
                    <p class="text-sm text-gray-300 break-words">${escapeHtml(text)}</p>
                </div>
            `;
            
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
            
            messageCount++;
            document.getElementById('messageCount').textContent = messageCount;
        }
        
        document.getElementById('chatForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            
            if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;
            
            ws.send(JSON.stringify({ type: 'chat', author: username, text }));
            input.value = '';
        });
        
        function startDurationTimer() {
            durationInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                const hours = Math.floor(elapsed / 3600);
                const minutes = Math.floor((elapsed % 3600) / 60);
                const seconds = elapsed % 60;
                
                document.getElementById('duration').textContent = 
                    `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }
        
        async function stopStream() {
            if (!confirm('End this live stream?')) return;
            
            if (hlsPlayer) hlsPlayer.destroy();
            if (ws) ws.close();
            if (durationInterval) clearInterval(durationInterval);
            
            try {
                await fetch(`${API_BASE}/stream/stop`, { method: 'POST' });
                window.location.href = '/summary.html';
            } catch (error) {
                alert('Error stopping stream');
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>